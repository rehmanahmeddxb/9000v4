{% extends "layout.html" %}
{% block content %}
<div class="mb-3">
    <h2 class="fw-bold text-warning mb-0">Settings</h2>
    <p class="text-white-50 small">System configuration and user management.</p>
</div>

<div class="row g-3">
    <div class="col-md-8">
        <div class="card border-secondary bg-dark shadow-sm h-100" style="border-radius: 12px;">
            <div class="card-header bg-transparent border-secondary py-2">
                <h6 class="fw-bold text-white mb-0"><i class="bi bi-people me-2 text-warning"></i>User Permissions</h6>
            </div>
            <div class="card-body p-3">
                {% if current_user.role == 'admin' %}
                <button class="btn btn-warning btn-sm fw-bold mb-3" data-bs-toggle="modal" data-bs-target="#addUserModal">+ New User</button>
                {% endif %}
                
                <div class="table-responsive">
                    <table class="table table-dark table-sm align-middle mb-0">
                        <thead class="x-small text-uppercase text-white-50">
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Permissions</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="small">
                            {% for u in users %}
                            <tr class="border-secondary">
                                <td class="fw-bold">{{ u.username }}</td>
                                <td><span class="badge {{ 'bg-warning text-dark' if u.role == 'admin' else 'bg-secondary' }}">{{ u.role }}</span></td>
                                <td>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% if u.can_view_stock %}<span class="badge bg-dark border border-secondary text-info">Stock</span>{% endif %}
                                        {% if u.can_view_daily %}<span class="badge bg-dark border border-secondary text-success">Daily</span>{% endif %}
                                        {% if u.can_view_history %}<span class="badge bg-dark border border-secondary text-primary">History</span>{% endif %}
                                        {% if u.can_import_export %}<span class="badge bg-dark border border-secondary text-warning">Import</span>{% endif %}
                                        {% if u.can_manage_directory %}<span class="badge bg-dark border border-secondary text-light">Dir</span>{% endif %}
                                    </div>
                                </td>
                                <td class="text-end">
                                    {% if current_user.role == 'admin' and u.username != 'admin' %}
                                    <button class="btn btn-link text-info p-0 me-2" data-bs-toggle="modal" data-bs-target="#editUser{{ u.id }}"><i class="bi bi-shield-check"></i></button>
                                    <a href="/delete_user/{{ u.id }}" class="btn btn-link text-danger p-0" onclick="return confirm('Remove user?')"><i class="bi bi-trash"></i></a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card border-secondary bg-dark shadow-sm mb-3" style="border-radius: 12px;">
            <div class="card-header bg-transparent border-secondary py-2">
                <h6 class="fw-bold text-white mb-0"><i class="bi bi-key me-2 text-warning"></i>Security</h6>
            </div>
            <div class="card-body p-3">
                <form action="/change_password" method="POST">
                    <div class="input-group input-group-sm">
                        <input type="password" name="password" class="form-control bg-dark text-white border-secondary" placeholder="New Password" required>
                        <button type="submit" class="btn btn-primary fw-bold">Update</button>
                    </div>
                </form>
            </div>
        </div>

        {% if current_user.role == 'admin' %}
        <div class="card border-0 shadow-sm" style="background: #1e293b; border: 2px solid #ef4444 !important; border-radius: 15px;">
            <div class="card-header bg-transparent border-danger py-2">
                <h6 class="fw-bold text-danger mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Granular Data Wipe</h6>
            </div>
            <div class="card-body p-3">
                <p class="text-white-50 x-small mb-3">Select datasets to clear. Action is irreversible.</p>
                <form action="{{ url_for('delete_selected_data') }}" method="POST">
                    <div class="row g-2 mb-3">
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="clients" id="wipeClients"><label class="form-check-label text-white" for="wipeClients">Clients</label></div></div>
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="pending_bills" id="wipeBills"><label class="form-check-label text-white" for="wipeBills">Pending Bills</label></div></div>
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="dispatching" id="wipeDispatch"><label class="form-check-label text-white" for="wipeDispatch">Dispatch (OUT)</label></div></div>
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="receiving" id="wipeReceive"><label class="form-check-label text-white" for="wipeReceive">Receive (IN)</label></div></div>
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="materials" id="wipeMaterials"><label class="form-check-label text-white" for="wipeMaterials">Materials</label></div></div>
                    </div>
                    <div class="mb-2">
                        <input type="text" name="confirm_text" class="form-control form-control-sm bg-dark text-white border-danger" placeholder="Type DELETE SELECTED" required>
                    </div>
                    <button type="submit" class="btn btn-danger btn-sm w-100 fw-bold" onclick="return confirm('Delete SELECTED datasets?')">Wipe Selected</button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modals -->
{% if current_user.role == 'admin' %}
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form action="/add_user" method="POST" class="modal-content border-secondary bg-dark text-white">
            <div class="modal-header border-secondary py-2">
                <h6 class="fw-bold mb-0">Create User</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" name="username" class="form-control bg-dark text-white border-secondary" placeholder="Username" required>
                </div>
                <div class="mb-3">
                    <input type="password" name="password" class="form-control bg-dark text-white border-secondary" placeholder="Password" required>
                </div>
                <div class="mb-3">
                    <select name="role" class="form-select bg-dark text-white border-secondary">
                        <option value="user">Standard User</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <h6 class="small fw-bold text-warning text-uppercase mb-2">Module Access</h6>
                <div class="row g-2">
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_stock" checked> <label>Stock Summary</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_daily" checked> <label>Daily Breakdown</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_history" checked> <label>History/Search</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_import_export"> <label>Import/Export</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_manage_directory"> <label>Client/Material</label></div></div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-warning w-100 fw-bold">Create Account</button>
            </div>
        </form>
    </div>
</div>

{% for u in users %}
{% if u.username != 'admin' %}
<div class="modal fade" id="editUser{{ u.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form action="/edit_user_permissions/{{ u.id }}" method="POST" class="modal-content border-secondary bg-dark text-white">
            <div class="modal-header border-secondary py-2">
                <h6 class="fw-bold mb-0">Edit Permissions: {{ u.username }}</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="x-small text-white-50">Role</label>
                    <select name="role" class="form-select bg-dark text-white border-secondary">
                        <option value="user" {{ 'selected' if u.role == 'user' }}>Standard User</option>
                        <option value="admin" {{ 'selected' if u.role == 'admin' }}>Administrator</option>
                    </select>
                </div>
                <h6 class="small fw-bold text-warning text-uppercase mb-2">Module Access</h6>
                <div class="row g-2">
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_stock" {{ 'checked' if u.can_view_stock }}> <label>Stock Summary</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_daily" {{ 'checked' if u.can_view_daily }}> <label>Daily Breakdown</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_history" {{ 'checked' if u.can_view_history }}> <label>History/Search</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_import_export" {{ 'checked' if u.can_import_export }}> <label>Import/Export</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_manage_directory" {{ 'checked' if u.can_manage_directory }}> <label>Client/Material</label></div></div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-warning w-100 fw-bold">Update Permissions</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endfor %}
{% endif %}
{% endblock %}
